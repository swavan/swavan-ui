<div class="rule">
    <b-form @submit="onSubmit" @reset="onReset" v-if="show">
        <div class="eachRow">
            <b-form-input id="swavan-rules-name" v-model.trim="form.name" required
                placeholder="Enter Name of the Rules">
            </b-form-input>
        </div>
        <div class="eachRow">
            <b-form-textarea id="swavan-rules-description" v-model.trim="form.description"
                placeholder="Enter rules descriptions" rows="3" max-rows="6">
            </b-form-textarea>
        </div>
        <div class="eachRow">
            <b-form-select id="input-source-type" v-model="form.source_type" :options="source_types" required>
            </b-form-select>
        </div>
        <div class="eachRow">
            <b-form-select id="input-operator" v-model="form.operator" :options="operators" required>
            </b-form-select>
        </div>
        <div class="eachRow">
            <b-form-input id="swavan-rules-name" v-model="form.source" required
                placeholder="e.g http://www.example/api/">
            </b-form-input>
        </div>
        <div class="eachRow" v-for="(response, responseIndex) in form.responses" v-bind:key="responseIndex">
            <b-card v-if=!response.mark_for_deletion border-variant="light" no-body id="add-response-logic"
                class="mb-1 custom-card">
                <b-card-header class="p-1" role="tab" header-border-variant="dark" header-bg-variant="dark"
                    text-variant="white">
                    <b-button v-b-toggle="responseIndex+'-response'" variant="dark">Response logic</b-button>
                    <b-button v-if="form.responses.length > 1" style="float: right"
                        @click="removeResponses(responseIndex)" v-b-tooltip.hover title="Remove response logic"
                        variant="dark">
                        <b-icon icon="trash" scale="1" variant="danger"></b-icon>
                    </b-button>
                    <b-button style="float: right" v-b-toggle="responseIndex+'-response'" variant="dark">
                        <span class="when-open">
                            <b-icon icon="arrows-collapse" scale="1" variant="light"></b-icon>
                        </span>
                        <span class="when-closed">
                            <b-icon icon="arrows-expand" scale="1" variant="light"></b-icon>
                        </span>
                    </b-button>

                </b-card-header>
                <b-collapse :id="responseIndex+'-response'" visible accordion="my-accordion" role="tabpanel">
                    <b-card-body>
                        <b-form-group description="Data source i.e. Redirect to another endpoint or mock data here">
                            <b-form-select :disabled="response && response.data && response.data.action_perform === 'e'" id="input-data-source-type" v-model="response.data_source_type"
                                :options="data_source_types" required></b-form-select>
                        </b-form-group>
                        <div v-if="(response.data && response.data.id) || response.data_source_type === 'r'"
                            class="link-line">

                            <b-form-input v-if="response.data_source_type === 'r'" id="swavan-rules-data"
                                v-model="response.data.link" placeholder="Enter Redirect URL">
                            </b-form-input>

                            <b-alert v-if="response.data_source_type === 'd' && response.data.link" variant="success"
                                show>
                               <a v-bind:href="response.data.link" target="blank">{{ response.data.link }}</a> 
                            </b-alert>
                            <b-button @click="load_mocked_response(responseIndex, response.data.id)" size="sm"
                                v-if="response.data_source_type === 'd' && response.data && !response.data.is_mock_loading && response.data.id && !response.data.content "
                                variant="link" type="button">
                                <b-icon icon="pencil-square" aria-hidden="true"></b-icon>
                            </b-button>
                            <b-icon v-if="response.data && response.data.is_mock_loading" icon="arrow-clockwise" animation="spin-pulse" font-scale="4"></b-icon>
                        </div>

                        <div class="custom-tab-view"
                            v-if="response.data_source_type === 'd' && ( response.data && response.data.id ? (response.data.content && response.data.action_perform !== 'h') : true ) ">
                            <b-tabs content-class="mt-3" align="left">
                                <b-tab class="custom-tab-body" title="Data">
                                    <div class="eachRow">
                                        <b-form-textarea
                                            class="mock-editor"
                                            id="mock-data"
                                            :required=true
                                            v-model="response.data.content"
                                            :state="response.data.content.length >= 1"
                                            placeholder="Enter mock data here"
                                            rows="5">
                                        </b-form-textarea>
                                        <b-form-checkbox id="checkbox-1" v-model="response.cloud_store_permission"
                                            name="checkbox-1" value="a" unchecked-value="n">
                                            Store mock data in the server
                                        </b-form-checkbox>
                                    </div>

                                    <div v-if="response.cloud_store_permission !== 'a'" class="notification">
                                        <b-alert show>
                                            This extension use <code> data: </code> schema to redirect the call and some
                                            of the browser does not allow that.
                                        </b-alert>
                                    </div>
                                </b-tab>
                                <b-tab v-if="response.cloud_store_permission === 'a'" class="custom-tab-body"
                                    title="Headers">
                                    <div v-for="(header, headerIndex) in response.data.headers"
                                        v-bind:key="headerIndex">
                                        <div class="custom-select-button eachRow">
                                            <b-form-input class="singleLine" id="swavan-header-key"
                                                v-model.trim="header.field" required placeholder="Header Field">
                                            </b-form-input>
                                            <b-form-input class="singleLine" id="swavan-header-value"
                                                v-model.trim="header.value" required placeholder="Value">
                                            </b-form-input>
                                            <b-button size="sm" variant="dark" v-b-tooltip.hover title="Remove header"
                                                @click="removeHeader(responseIndex, headerIndex)" class="mb-1">
                                                <b-icon icon="trash" variant="danger" aria-label="Remove header logic">
                                                </b-icon>
                                            </b-button>
                                        </div>
                                    </div>
                                    <b-button size="md" variant="link" v-b-tooltip.hover title="Add more header"
                                        @click="addHeader(responseIndex)" class="mb-1">
                                        <b-icon icon="file-plus-fill" aria-label="Add more header"></b-icon>
                                        Add {{ response.data_source_type === 'd' ? "Response" : "Request" }} header
                                    </b-button>
                                </b-tab>
                                <b-tab v-if="response.cloud_store_permission === 'a'" class="custom-tab-body"
                                    title="Status">
                                    <b-form-group description="Status code will be return in response">
                                        <b-form-input type="number" id="swavan-rules-data"
                                            v-model="response.data.status" placeholder="Status code">
                                        </b-form-input>
                                    </b-form-group>
                                </b-tab>
                                <b-tab v-if="response.cloud_store_permission === 'a'" class="custom-tab-body"
                                    title="Content Type">
                                    <!-- Filter section -->
                                    <b-form-group description="Content type of the response data">
                                        <b-form-input type="text" id="swavan-rules-data"
                                            v-model="response.data.contentType" placeholder="Content Type">
                                        </b-form-input>
                                    </b-form-group>
                                </b-tab>
                            </b-tabs>
                        </div>

                        <b-form-group description="Use this response logic for given HTTP method">
                            <b-form-select id="input-source-http-method" v-model="response.http_method"
                                :options="http_methods"></b-form-select>
                        </b-form-group>

                        <div class="filter" v-bind:class="[ (response.filters && response.filters.length > 0) ? 'custom-tab-view' : '' ]">
                            <div v-for="(filter, filterIndex) in response.filters" v-bind:key="filterIndex">
                                <div  class="custom-select-button  eachRow">
                                    <b-select class="mb-2 mr-sm-2 mb-sm-0" id="input-source-filter-by-option"
                                        v-model="filter.filter_by" :options="filter_by_options">
                                    </b-select>
                                    <b-tooltip :target="'filter-key-index'+responseIndex+filterIndex"
                                        triggers="hover">
                                        {{ filter.key || "Add Filter Key" }}
                                    </b-tooltip>
                                    <b-input class="mb-2 mr-sm-2 mb-sm-0" :id="'filter-key-index'+responseIndex+filterIndex"
                                        v-model.trim="filter.key" required placeholder="Enter Filter Key">
                                    </b-input>
                                    <b-tooltip  :target="'filter-value-index'+responseIndex+filterIndex"
                                        triggers="hover">
                                        {{ filter.value || "Add Filter value" }}
                                    </b-tooltip>
                                    <b-input class="mb-2 mr-sm-2 mb-sm-0" :id="'filter-value-index'+responseIndex+filterIndex"
                                        v-model.trim="filter.value" required placeholder="Enter Filter Value">
                                    </b-input>
                                    <b-button size="sm" variant="light" v-b-tooltip.hover title="Remove filter logic"
                                        @click="removeFilters(responseIndex, filterIndex)" class="mb-1">
                                        <b-icon icon="trash" variant="danger" aria-label="Remove filter logic"></b-icon>
                                    </b-button>
                                </div>
                            </div>

                            <b-button size="md" variant="light" v-b-tooltip.hover title="Add more filter logic"
                                @click="addFilters(responseIndex)" class="mb-1">
                                <b-icon icon="file-plus-fill" aria-label="Add more and logic"></b-icon>
                                More Filter
                            </b-button>
                        </div>

                        <div>
                            <b-form-checkbox switch v-model="response.is_logic_enabled" size="lg">
                                {{ response.is_logic_enabled ? 'Enable' : 'Disable' }}
                            </b-form-checkbox>
                        </div>

                    </b-card-body>
                </b-collapse>
            </b-card>
        </div>
        <div class="eachRow">
            <b-button @click="addResponses()" v-b-tooltip.hover title="Add more response logic" variant="dark">
                <b-icon icon="plus-circle-fill" scale="1" variant="light"></b-icon>
                Add Response
            </b-button>
        </div>
        <div class="eachRow">
            <b-form-checkbox v-model="form.is_enabled">
                Activate rule on create
            </b-form-checkbox>
        </div>
        <div class="eachRow">
            <b-icon v-if="isSaving" icon="arrow-clockwise" animation="spin-pulse" font-scale="4"></b-icon>
            <b-button v-if="!isSaving" size="md" :disabled=!isFormValid variant="primary" type="submit">
                <b-icon icon="download" aria-hidden="true"></b-icon>
                Save
            </b-button>
            &nbsp;
            <b-button v-if="enableDelete" size="sl" variant="danger" type="button" @click="deleteRule">
                <b-icon icon="trash-fill" aria-hidden="true"></b-icon>
                Delete
            </b-button>
        </div>
    </b-form>
</div>
